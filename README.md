# Ứng dụng học sâu vào phát hiện và phân loại mã độc
## I.Giới thiệu
- Phát triển ứng dụng dùng để phát hiện và phân loại mã độc, cho phép sử dụng được ở máy tính cá nhân, hoặc thông qua web browser. Có thể thực hiện tải tệp file để phân tích, và cho ra kết quả trực quan.
- Các tính năng tổng quát của ứng dụng:
    +  Phân loại mã độc theo loại, áp dụng phương pháp phân tích PE Imports.
    +  Kiểm tra biến thể, thông qua phương pháp ảnh xám.
    +  Thực hiện kiểm tra từ dữ liệu của VirusTotal.
  
![image](https://github.com/huyat16/malware_detect/assets/122583210/c88bede2-f91e-4a1b-8fee-404d6646c2c2)
## II. Tính năng và giải thích
### 1. Phát hiện và phân loại mã độc dựa trên PE Imports 
#### Nguồn dữ liệu:
[Virrushare](https://virusshare.com/)

[VirusSign](http://samples.virussign.com/samples/)

[MalwareBazaar](https://bazaar.abuse.ch/browse)
#### 1.1. Import Address Table (IAT)
Import Address Table(IAT) là một phần của PE file, chứa các thông tin về chức năng(function) được sử dụng trong file thực thi.
Ví dụ: 

Sử dụng một hàm chức năng để trích xuất PE Imports:
```python
import pefile
for entry in pe.DIRECTORY_ENTRY_IMPORT:
   for function in entry.imports:
      if function.name.decode("utf-8") == "None" or "?" in function.name.decode("utf-8"):
         pass
      else:                                  
         imported_functions.append(f"{function.name.decode('utf-8')}")
```
#### 1.2. Đánh nhãn
Các mã độc được phân loại ở trong các folder riêng biệt, sau đó được trích xuất các Imports, và cho vào tập file Imports.csv và sau cùng là dùng tập file này để huấn luyện model.

![folder](https://github.com/huyat16/malware_detect/assets/122583210/5d91de09-ab3c-4ffe-a996-7c6ec74f2653)

##### Tổng hợp Imports thường xuyên sử dụng tương ứng với từng loại mã độc:
##### - Backdoor
![backdoor](https://github.com/huyat16/malware_detect/assets/122583210/dc3a7ae6-0eda-44bb-bc98-d59263a65b65)

##### - Downloader
![Downloader](https://github.com/huyat16/malware_detect/assets/122583210/35b367a5-c95f-4d4c-a09d-b964dad620bf)

##### - Keylogger
![Keylogger](https://github.com/huyat16/malware_detect/assets/122583210/5c496dfa-3f72-4e0c-8c49-d453fee2edad)

##### - Miner
![Miner](https://github.com/huyat16/malware_detect/assets/122583210/b6a73573-e61d-4c41-bbdc-992894f3c865)

##### - Ransomaware
![Ransomware](https://github.com/huyat16/malware_detect/assets/122583210/3b8bd21c-96fb-4fbf-93d3-e2fda559714d)

##### - Rogue Software
![Rougue](https://github.com/huyat16/malware_detect/assets/122583210/7d550b8c-26b6-4140-853a-b539f93657d1)

##### - Trojan
![Trojan](https://github.com/huyat16/malware_detect/assets/122583210/4a46276a-5918-48de-8453-e1caac793c39)

##### - Worm
![Worm](https://github.com/huyat16/malware_detect/assets/122583210/435d8d48-9a02-43ac-8872-ae95b60704a9)

##### Tập file Imports.csv

#### 1.3. Kết quả thu được sau khi huấn luyện
Source Code dùng để huấn luyện mode:
[Mô hình huấn luyện](Train/MachineLearning_Malware_PE_Import.ipynb)
![image](https://github.com/huyat16/malware_detect/assets/122583210/84920533-7448-471f-912b-2b611ff22b1c)

### 2. Phát hiện loại biến thể của mã độc thông qua ảnh xám
#### Nguồn dữ liệu:
[Malimg](https://paperswithcode.com/sota/malware-classification-on-malimg-dataset)

#### 2.1. Mã độc đa hình (polymorphic malware)
Mã độc đa hình là loại mã độc có cấu trúc thay đổi mỗi lần lây lan, việc thay đổi cấu trúc giúp cho loại mã độc này có thể tránh khỏi việc bị phát hiện bởi những ứng dụng phát hiện mã độc truyền thống(phát hiện thông qua chữ ký-dãy hash).
#### 2.2. Chuyển đổi ảnh xám để phát hiện mã độc đa hình
Mã độc đa hình chỉ thực hiện một số thay đổi nhỏ trong bộ mã của chúng, điều này dẫn đến khả năng thay đổi chữ ký, nhưng phần lớn còn lại của mã giữ nguyên. Nhờ tính chất này, khi chuyển đổi các biến thể về ảnh xám và thực hiện quá trình học máy trên các hình ảnh này, chúng ta có thể dễ dàng phát hiện được các biến thể của chúng.
##### Tổng hợp 25 chủng mã độc và ảnh xám các biến thể của chúng:
![image](https://github.com/huyat16/malware_detect/assets/122583210/64246fa9-4dd1-458c-a837-624e01b0b61b)
Sử dụng một hàm chức năng để chuyển đổi dữ liệu của tập file sang ảnh xám:
```python
import numpy as np
import cv2
def exfile_image(input_file_name):
    #Read the whole file to data
    with open(input_file_name, 'rb') as binary_file:        
        data = binary_file.read()
    data_len = len(data)
    d = np.frombuffer(data, dtype=np.uint8)
    sqrt_len = int(ceil(sqrt(data_len)))
    new_len = sqrt_len*sqrt_len
    pad_len = new_len - data_len
    padded_d = np.hstack((d, np.zeros(pad_len, np.uint8)))
    im = np.reshape(padded_d, (sqrt_len, sqrt_len))
    cv2.imwrite('im.png', im)
    cv2.waitKey(0)
    cv2.destroyAllWindows()
    im = cv2.resize(im, (64, 64))
    return im
```
#### 2.3. Sử dụng huấn luyện bằng CNN
#### 2.3.1. CNN(Convolutional Neural Network)
Áp dụng mạng nơ-ron tích chập, để phân tích hình ảnh và phát hiện ra biến thể của mã độc.

#### 2.4. Kết quả thu được sau quá trình huấn luyện
Source code huấn luyện mô hình:
[Mô hình huấn luyện](Train/Malware_GrayImage.ipynb)

### 3. Sử dụng VirusTotal để phân tích
Việc sử dụng kết hợp tài nguyên sẵn có của VirusTotal giúp tăng cường độ tin cậy của ứng dụng, đồng thời cung cấp thêm các phân tích mã độc của nhiều tổ chức, giúp cho việc phát hiện và phân loại mã độc trở nên tổng quan.
#### Hash tập file và gọi API VirusTotal
Sử dụng một hàm chức năng để thực hiện hash tập file với thuật toán MD5 và thực hiện kiểm tra thông qua gọi API của VirusTotal:
```python
import hashlib
import requests
def call_api_virustotal(file_path):
    # Calculate the MD5 hash of the file
    with open(file_path, "rb") as file:
        file_contents = file.read()
        md5_hash = hashlib.md5(file_contents).hexdigest()
    
    # Define the VirusTotal API URL
    api_url = "https://www.virustotal.com/vtapi/v2/file/report"
    
    # Set the API key as a parameter in the request
    params = {
        'apikey': '0822dbdeafbc2038c10ddsfdsafd0fd2fb8991247bfsadc3dc5c3e5ccb37cbd298',
        'resource': md5_hash
    }
    # Make the HTTP request to VirusTotal
    response = requests.get(api_url, params=params)
```
## III. Ứng dụng
### 1. Giới thiệu
- Ứng dụng được xây dựng  trên nền tảng ngôn ngữ lập trình python và framework streamlit, cho phép có thể sử dụng thông qua web browser.

### 2. Sử dụng
- Ứng dụng cho phép tải một tệp file bất kì, với đuôi ".exe" hoặc ".vir", sau đó ứng dụng sẽ thực hiện phân tích tệp file. Sử dụng những gì đã được học ở 2 model trước, để đưa ra kết quả liệu tập file đó có thể là một loại mã độc, và có thuộc biến thể nào hay không. Sau cùng thực hiện gọi API của VirusTotal để kiểm tra.
![image](https://github.com/huyat16/malware_detect/assets/122583210/d9b7b988-1c37-4e5a-97aa-d6c0813483e6)

               ![image](https://github.com/huyat16/malware_detect/assets/122583210/bdf0975d-c6fb-4ce7-9a6f-1acc4afe8ac3)
![image](https://github.com/huyat16/malware_detect/assets/122583210/d8e37523-bca2-4318-91f3-fcb75368350d)

### _Nguồn tài liệu_
[1] Wikipedia. (n.d.). Malware. Retrieved from wikipedia.org/wiki/Malware

[2] Kapoor, S. (2020). Mastering Machine Learning for Penetration Testing: Develop an extensive skill set to break self-learning systems using Python. Packt Publishing.

[3] CS50. (n.d.). CS50’s Introduction to Artificial Intelligence with Python. Retrieved from https://cs50.harvard.edu/ai

[4] Sarker, I. H. (2019). Deep Learning: A Comprehensive Overview on Techniques, Taxonomy, Applications and Research Directions. CRC Press.

[5] Kanncaa1. (n.d.). Machine Learning CNN. Retrieved from kaggle.com/code/kanncaa1/convolutional-neural-network-cnn-tutorial

[6] TensorFlow. (n.d.). Strategies to prevent overfitting. Retrieved from https://www.tensorflow.org/tutorials/keras/overfit_and_underfit#strategies_to_prevent_overfitting

[7] WhiteHat Vietnam. (n.d.). Tản mạn về Machine Learning trong Malware analysis. Retrieved from https://whitehat.vn/threads/tan-man-ve-machine-learning-trong-malware-analysis.17021/

[8] Yousuf, M. I., Anwer, I., Riasat, A., Zia, K. T., & Kim, S. (n.d.). Windows malware detection based on static analysis with multiple features.

[9] Cuckoo Foundation. (2015). Cuckoo Sandbox Book. Retrieved from http://docs.cuckoosandbox.org/en/latest/introduction/what/

[10] 0xRick. (n.d.). PE Imports (Import Directory Table, ILT, IAT). Retrieved from 0xrick.github.io/win-internals/pe6/

[11] Kapoor, S. (2020). Mastering Machine Learning for Penetration Testing: Develop an extensive skill set to break self-learning systems using Python. Packt Publishing.

[12] International Journal of Computer Applications. (2021). Volume 183 – No. 32, October 2021: Classification of Malware using Machine learning and Deep learning Techniques.

[13] Visweswaran, N. (n.d.). Automated PE32 Threat Classification using Import Table and Deep Neural Networks.

[14] Nataraj, L., Karthikeyan, S., Jacob, G., & Manjunath, B. S. (n.d.). Malware images: visualization and automatic classification.

[15] Kosmidis, K., & Kalloniatis, C. (n.d.). Machine learning and images for malware detection and classification.

[16] Gibert, D., Mateu, C., Planes, J., et al. (n.d.). Using convolutional neural networks for classification of malware represented as images.





